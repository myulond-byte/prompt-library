# システム構成 - 技術詳細

## 🏗️ アーキテクチャ概要

```
┌─────────────────────────────────────────┐
│         参加者（ユーザー）                │
└─────────────────┬───────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│    一括登録システム（フロントエンド）      │
│  http://src-nouhin.raindrop.jp/_ikkatu/ │
└─────────────────┬───────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│         データベース（MySQL）             │
│      LAA1221658-nouhin                   │
└───┬─────────────────────────┬───────────┘
    │                         │
    │  ①データ取得            │  ③登録完了フラグ
    │                         │
    ↓                         ↓
┌──────────────┐       ┌──────────────┐
│自動登録プログラム│       │納品管理システム│
│auto_regist.php │       │   /_admin/   │
│(Cron: 日曜23時)│       └──────────────┘
└───┬──────────┘
    │
    │  ②自動登録処理
    │
    ├─────→ エキスパフォーム① (/fx2246/lLnYf8)
    ├─────→ エキスパフォーム② (/fx2246/IOo7YL)
    ├─────→ エキスパフォーム③ (/fx2246/n5GgUQ)
    └─────→ 完了報告メール (support@src.mods.jp)
                  │
                  ↓
          ┌──────────────┐
          │  参加者宛配信  │
          │  (毎週月曜20時)│
          └──────────────┘
                  │
                  ↓
          ┌──────────────┐
          │   納品ページ   │
          │  src.ciao.jp  │
          └──────────────┘
```

---

## 🗄️ データベース設計

### 接続情報
```
Host: mysql147.phy.lolipop.lan
Database: LAA1221658-nouhin
User: LAA1221658
Password: okanemoti789
管理画面: https://mysqladmin.lolipop.jp/pma/
```

### テーブル構造（推定）

#### 1. ikkatu_registrations（一括登録テーブル）
```sql
CREATE TABLE ikkatu_registrations (
  id INT PRIMARY KEY AUTO_INCREMENT,
  email VARCHAR(255) NOT NULL UNIQUE,
  registration_date DATETIME NOT NULL,
  scheduled_sunday DATETIME NOT NULL,
  status ENUM('pending', 'processing', 'completed', 'error') DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  processed_at DATETIME,
  error_message TEXT,
  INDEX idx_status (status),
  INDEX idx_scheduled_sunday (scheduled_sunday)
);
```

| カラム名 | 型 | 説明 |
|---------|---|------|
| id | INT | 主キー |
| email | VARCHAR(255) | メールアドレス（ユニーク） |
| registration_date | DATETIME | 登録日時 |
| scheduled_sunday | DATETIME | 処理予定の日曜日 |
| status | ENUM | 処理状態（pending/processing/completed/error） |
| created_at | TIMESTAMP | レコード作成日時 |
| processed_at | DATETIME | 処理完了日時 |
| error_message | TEXT | エラーメッセージ |

#### 2. nouhin_schedules（納品スケジュールテーブル）
```sql
CREATE TABLE nouhin_schedules (
  id INT PRIMARY KEY AUTO_INCREMENT,
  email VARCHAR(255) NOT NULL UNIQUE,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  campaign_id VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_email (email),
  INDEX idx_start_date (start_date)
);
```

| カラム名 | 型 | 説明 |
|---------|---|------|
| id | INT | 主キー |
| email | VARCHAR(255) | メールアドレス（ユニーク） |
| start_date | DATE | 納品開始日 |
| end_date | DATE | 納品終了日 |
| campaign_id | VARCHAR(50) | キャンペーンID（ezwf等） |
| created_at | TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | レコード更新日時 |

---

## 🔧 主要コンポーネント

### 1. 一括登録フォーム（/ikkatu/index.php）

#### 機能
```php
<?php
// 簡略化したイメージコード

// メールアドレスのバリデーション
function validateEmail($email) {
    return filter_var($email, FILTER_VALIDATE_EMAIL);
}

// 次の日曜日を計算
function getNextSunday($date = null) {
    $date = $date ? new DateTime($date) : new DateTime();
    $dayOfWeek = $date->format('w');
    
    if ($dayOfWeek == 0) {
        // 今日が日曜日ならそのまま
        return $date;
    } else {
        // 次の日曜日
        $daysUntilSunday = 7 - $dayOfWeek;
        return $date->modify("+{$daysUntilSunday} days");
    }
}

// 登録処理
if ($_POST['email']) {
    $email = $_POST['email'];
    
    // バリデーション
    if (!validateEmail($email)) {
        $error = "メールアドレスが正しくありません";
    }
    
    // 重複チェック
    $existing = checkExistingEmail($email);
    if ($existing) {
        $error = "登録済みのメールアドレスです";
    }
    
    // 次の日曜日を計算
    $nextSunday = getNextSunday();
    $nextSunday->setTime(23, 0, 0);
    
    // データベースに保存
    $result = saveRegistration($email, $nextSunday);
    
    if ($result) {
        $message = "登録しました";
        $scheduledDate = $nextSunday->format('Y-m-d');
    }
}
?>
```

---

### 2. 自動登録プログラム（auto_regist.php）

#### Cron設定
```bash
# ロリポップのCron設定
# 毎週日曜 23:00に実行

0 23 * * 0 /usr/bin/php /home/users/2/raindrop.jp-src-nouhin/web/_ikkatu/auto_regist.php
```

#### 処理フロー
```php
<?php
// 簡略化したイメージコード

// 1. 本日処理すべきレコードを取得
$today = new DateTime();
$today->setTime(23, 0, 0);

$pendingRegistrations = getPendingRegistrations($today);

if (empty($pendingRegistrations)) {
    logMessage("処理対象のレコードなし");
    exit;
}

// 2. 各メールアドレスを処理
foreach ($pendingRegistrations as $registration) {
    $email = $registration['email'];
    
    try {
        // ステータスを「処理中」に更新
        updateStatus($registration['id'], 'processing');
        
        // エキスパフォーム①に登録
        $result1 = registerToExpertForm1($email);
        
        // エキスパフォーム②に登録
        $result2 = registerToExpertForm2($email);
        
        // エキスパフォーム③に登録
        $result3 = registerToExpertForm3($email);
        
        // 納品システムに登録
        $result4 = registerToNouhinSystem($email, $registration['registration_date']);
        
        // 全て成功したらステータスを「完了」に
        updateStatus($registration['id'], 'completed');
        
        $successEmails[] = $email;
        
    } catch (Exception $e) {
        // エラーが発生したらログに記録
        updateStatus($registration['id'], 'error', $e->getMessage());
        $errorEmails[] = $email;
        logError($email, $e->getMessage());
    }
}

// 3. 完了報告メールを送信
sendCompletionReport($successEmails, $errorEmails);

// エキスパAPI連携の例
function registerToExpertForm2($email) {
    $apiUrl = "https://ex-pa.jp/api/...";
    $formId = "148";
    
    $data = [
        'email' => $email,
        'form_id' => $formId,
        // メルマガIDの指定
        'melmaga_ids' => ['src1to4', 'srckeiba', 'kob2']
    ];
    
    $response = callExpertApi($apiUrl, $data);
    return $response;
}
?>
```

---

### 3. 突発対応フォーム（/_admin/regist2.php）

#### 機能
```php
<?php
// 簡略化したイメージコード

// 管理者ログインチェック
session_start();
if (!isLoggedIn()) {
    header("Location: login.php");
    exit;
}

// 登録日とメールアドレスを受け取る
if ($_POST['email'] && $_POST['registration_date']) {
    $email = $_POST['email'];
    $registrationDate = new DateTime($_POST['registration_date']);
    
    // 納品スケジュールを計算
    $schedule = calculateNouhinSchedule($registrationDate);
    
    if ($_POST['confirm']) {
        // 確認済みなら納品DBに登録
        registerToNouhinDB($email, $schedule);
        $message = "登録完了しました";
    } else {
        // まず計算結果を表示
        $preview = [
            'email' => $email,
            'start_date' => $schedule['start_date']->format('Y-m-d'),
            'end_date' => $schedule['end_date']->format('Y-m-d')
        ];
    }
}

// スケジュール計算（17週間プログラム）
function calculateNouhinSchedule($registrationDate) {
    $startDate = clone $registrationDate;
    $endDate = clone $registrationDate;
    $endDate->modify('+17 weeks');
    
    return [
        'start_date' => $startDate,
        'end_date' => $endDate
    ];
}
?>
```

---

## 🔌 API連携

### エキスパAPI

#### 認証情報
```
エキスパアカウント:
URL: https://ex-pa.jp/
User: info@src.mods.jp
Pass: VGFDW758Gfhj
```

#### フォーム一覧
```
フォーム①: /fx2246/lLnYf8
- 名前: SRC新システムエキスパ登録
- ID: 99
- メルマガ連携: なし

フォーム②: /fx2246/IOo7YL
- 名前: SRC追加メルマガ登録
- ID: 148
- メルマガ連携: あり
  - src1to4（SRC参加者限定）
  - srckeiba（オフ会案内）
  - kob2（にこにこ本舗）

フォーム③: /fx2246/n5GgUQ
- 名前: SRC2020年納品システム
- ID: 197/481
- メルマガ連携: あり
  - ezwf（SRC2020年納品システム）
```

#### API呼び出しの例
```javascript
// エキスパAPI連携のイメージ
const registerToExpert = async (email, formId) => {
    const response = await fetch('https://ex-pa.jp/api/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer YOUR_API_KEY'
        },
        body: JSON.stringify({
            email: email,
            form_id: formId
        })
    });
    
    return await response.json();
};
```

---

## 📧 メール送信

### 完了報告メール

#### 送信先
```
宛先: support@src.mods.jp
件名: SRC参加者登録情報
```

#### メール内容（例）
```
SRC参加者登録情報

登録日時: 2023-03-19 01:49:55

登録アドレス:
dharmallez@gmail.com
dharmallez@gmail.com

---
このメールは自動送信されています。
```

#### 実装例
```php
<?php
function sendCompletionReport($successEmails, $errorEmails) {
    $to = "support@src.mods.jp";
    $subject = "SRC参加者登録情報";
    
    $body = "SRC参加者登録情報\n\n";
    $body .= "登録日時: " . date('Y-m-d H:i:s') . "\n\n";
    
    if (!empty($successEmails)) {
        $body .= "登録アドレス:\n";
        foreach ($successEmails as $email) {
            $body .= $email . "\n";
        }
    }
    
    if (!empty($errorEmails)) {
        $body .= "\nエラー:\n";
        foreach ($errorEmails as $email) {
            $body .= $email . "\n";
        }
    }
    
    $headers = "From: src-nouhin@raindrop.jp";
    
    mail($to, $subject, $body, $headers);
}
?>
```

---

## 🔒 セキュリティ

### 実装されている対策

#### 1. 認証
```php
// 管理画面へのBasic認証
// .htaccess + .htpasswd

AuthType Basic
AuthName "Restricted Area"
AuthUserFile /path/to/.htpasswd
Require valid-user
```

#### 2. SQLインジェクション対策
```php
// プリペアドステートメントの使用
$stmt = $pdo->prepare("INSERT INTO ikkatu_registrations (email, scheduled_sunday) VALUES (?, ?)");
$stmt->execute([$email, $scheduledSunday]);
```

#### 3. XSS対策
```php
// 出力時のエスケープ
echo htmlspecialchars($email, ENT_QUOTES, 'UTF-8');
```

#### 4. CSRF対策
```php
// トークンの生成と検証
session_start();
$token = bin2hex(random_bytes(32));
$_SESSION['csrf_token'] = $token;

// フォーム送信時の検証
if ($_POST['csrf_token'] !== $_SESSION['csrf_token']) {
    die("Invalid token");
}
```

---

## 📊 ログ管理

### ログファイル（推定）

```
/home/users/2/raindrop.jp-src-nouhin/web/_ikkatu/logs/
├── registration.log（登録ログ）
├── auto_regist.log（自動登録ログ）
├── error.log（エラーログ）
└── api.log（API連携ログ）
```

### ログフォーマット
```
[2023-03-19 23:00:01] INFO: 自動登録処理開始
[2023-03-19 23:00:05] SUCCESS: dharmallez@gmail.com - エキスパ①登録完了
[2023-03-19 23:00:08] SUCCESS: dharmallez@gmail.com - エキスパ②登録完了
[2023-03-19 23:00:11] SUCCESS: dharmallez@gmail.com - エキスパ③登録完了
[2023-03-19 23:00:14] SUCCESS: dharmallez@gmail.com - 納品DB登録完了
[2023-03-19 23:00:20] INFO: 完了報告メール送信完了
[2023-03-19 23:00:21] INFO: 自動登録処理終了
```

---

## 🚀 パフォーマンス

### 処理時間
```
1人あたりの処理時間: 約10〜15秒
- エキスパAPI呼び出し: 3回 × 2秒 = 6秒
- DB処理: 3秒
- メール送信: 1秒
- その他: 2秒

週50人の場合: 約10分
週100人の場合: 約20分
```

### スケーラビリティ
```
現在の設計:
✅ 週100人程度まで問題なし
⚠️ 週500人を超えると処理時間が長くなる可能性

改善案:
- バッチ処理の並列化
- API呼び出しのキュー化
- 複数回に分けて実行
```

---

## 🔧 保守・運用

### 定期確認項目
```
【毎週】
□ 日曜23時のCron実行確認
□ エラーログの確認
□ 完了報告メールの受信確認

【毎月】
□ データベースのバックアップ
□ ディスク容量の確認
□ アクセスログの確認

【四半期】
□ エキスパAPIの仕様変更確認
□ PHPバージョンの確認
□ セキュリティアップデート
```

### トラブルシューティング

#### よくある問題

**1. Cronが実行されない**
```
原因: サーバー設定の変更、ファイルパスの誤り
確認: ロリポップの管理画面 > Cron設定
解決: パスとタイミングの再設定
```

**2. エキスパAPI連携エラー**
```
原因: API仕様変更、認証エラー、レート制限
確認: api.logの確認
解決: APIキーの再発行、リトライ処理の追加
```

**3. 重複登録**
```
原因: ユニーク制約の欠如、処理の二重実行
確認: データベースの確認
解決: ユニーク制約の追加、ロック機構の実装
```

---

## 📚 技術スタック詳細

```
【言語・フレームワーク】
- PHP 7.4+ (フォーム処理、バッチ処理)
- MySQL 5.7+ (データベース)
- HTML5/CSS3/JavaScript (UI)

【ライブラリ】
- PDO (データベース接続)
- cURL (API連携)

【インフラ】
- ロリポップ!レンタルサーバー
- Cron (定期実行)

【ツール】
- phpMyAdmin (DB管理)
- Git (バージョン管理・推定)
```

---

**作成日: 2023年頃**
**最終更新: 2025年2月6日（アーカイブ化）**
