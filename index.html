<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a1814">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PromptLib">
<link rel="manifest" href="./manifest.json">
<title>Prompt Library</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap');
* { box-sizing: border-box; margin: 0; padding: 0; }
html { overflow-x: hidden; }

/* LIGHT MODE */
:root {
  --bg: #f5f3ee;
  --bg2: #eceae3;
  --surface: #ffffff;
  --border: #dbd8cf;
  --ink: #1a1814;
  --ink2: #6b6760;
  --ink3: #aaa;
  --red: #c94a2a;
  --green: #2a7a52;
  --blue: #2a4fc9;
  --amber: #d4820a;
}

/* DARK MODE */
body.dark {
  --bg: #1a1814;
  --bg2: #252220;
  --surface: #2c2926;
  --border: #3d3a36;
  --ink: #f0ede8;
  --ink2: #9e9b96;
  --ink3: #666;
  --red: #e8704a;
  --green: #4aaa7a;
  --blue: #6a8fe8;
  --amber: #e8a030;
}

body { background: var(--bg); color: var(--ink); font-family: 'Noto Sans JP', sans-serif; font-weight: 400; font-size: 17px; line-height: 1.9; min-height: 100vh; overflow-x: hidden; transition: background .2s, color .2s; }
@media (max-width: 640px) { body { font-size: 18px; } }

/* TOPBAR */
.topbar { position: sticky; top: 0; z-index: 100; background: var(--surface); border-bottom: 2px solid var(--ink); padding: 0 16px; transition: background .2s, border-color .2s; }
.topbar-inner { display: flex; align-items: center; gap: 12px; height: 52px; max-width: 860px; margin: 0 auto; }
.logo { font-family: 'Outfit', sans-serif; font-weight: 900; font-size: 16px; flex-shrink: 0; white-space: nowrap; color: var(--ink); }
.logo em { font-style: normal; color: var(--red); }
.search-wrap { flex: 1; position: relative; min-width: 0; }
.search-ico { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--ink3); font-size: 14px; pointer-events: none; }
#search { width: 100%; background: var(--bg); border: 1.5px solid var(--border); border-radius: 8px; padding: 7px 12px 7px 30px; font-family: 'Noto Sans JP', sans-serif; font-size: 14px; color: var(--ink); outline: none; -webkit-appearance: none; appearance: none; transition: background .2s, border-color .2s, color .2s; }
#search:focus { border-color: var(--ink); }
#search::placeholder { color: var(--ink3); }

/* DARK MODE TOGGLE */
.btn-dark { background: transparent; border: 1.5px solid var(--border); border-radius: 8px; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; flex-shrink: 0; transition: all .15s; color: var(--ink2); }
.btn-dark:hover { border-color: var(--ink); color: var(--ink); }

/* CATEGORY TABS */
.cat-wrap { background: var(--surface); border-bottom: 1px solid var(--border); transition: background .2s; }
.cat-inner { display: flex; gap: 6px; overflow-x: auto; padding: 8px 16px; scrollbar-width: none; max-width: 860px; margin: 0 auto; -webkit-overflow-scrolling: touch; }
.cat-inner::-webkit-scrollbar { display: none; }
.cat-btn { flex-shrink: 0; background: var(--bg); border: 1.5px solid var(--border); border-radius: 20px; padding: 5px 14px; font-family: 'Noto Sans JP', sans-serif; font-size: 13px; color: var(--ink2); cursor: pointer; white-space: nowrap; transition: all .15s; }
.cat-btn.active { background: var(--ink); border-color: var(--ink); color: var(--bg); }
.cat-btn.fav-btn { border-color: #e8a0b0; color: #c94a6a; }
.cat-btn.fav-btn.active { background: #c94a6a; border-color: #c94a6a; color: #fff; }
.cat-btn.hist-btn { border-color: var(--blue); color: var(--blue); }
.cat-btn.hist-btn.active { background: var(--blue); border-color: var(--blue); color: #fff; }

/* MAIN */
.main { max-width: 860px; margin: 0 auto; padding: 16px 16px 80px; }
.stats { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
.stat { display: flex; align-items: baseline; gap: 5px; }
.stat-n { font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 22px; }
.stat-l { font-size: 11px; color: var(--ink2); }

/* SECTION */
.section { margin-bottom: 28px; }
.section-head { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1.5px solid var(--border); cursor: pointer; -webkit-tap-highlight-color: transparent; user-select: none; }
.section-head:hover { opacity: 0.75; }
.section-name { font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 16px; flex: 1; }
.section-cnt { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--ink2); }
.section-chevron { color: var(--ink3); font-size: 12px; transition: transform .2s; flex-shrink: 0; }
.section.collapsed .section-chevron { transform: rotate(-90deg); }
.section.collapsed .section-body { display: none; }

/* CARD */
.card { background: var(--surface); border: 1.5px solid var(--border); border-radius: 10px; margin-bottom: 8px; overflow: hidden; transition: background .2s, border-color .2s; }
.card.is-fav { border-color: #e8a0b0; }
.card-top { display: flex; align-items: center; padding: 12px 14px; cursor: pointer; gap: 10px; -webkit-tap-highlight-color: transparent; }
.card-icon { font-size: 18px; flex-shrink: 0; width: 26px; text-align: center; }
.card-meta { flex: 1; min-width: 0; }
.card-title { font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 17px; word-break: break-all; overflow-wrap: anywhere; line-height: 1.3; color: var(--ink); }
@media (max-width: 640px) { .card-title { font-size: 18px; line-height: 1.3; } }
.card-desc { font-size: 12px; color: var(--ink2); margin-top: 2px; word-break: break-all; overflow-wrap: anywhere; }
.card-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }

/* BUTTONS */
.btn-fav { background: transparent; border: none; font-size: 18px; cursor: pointer; line-height: 1; padding: 2px; flex-shrink: 0; transition: transform .15s; -webkit-tap-highlight-color: transparent; }
.btn-fav:hover { transform: scale(1.2); }
.btn-copy { background: var(--bg); border: 1.5px solid var(--border); border-radius: 6px; padding: 4px 10px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--ink2); cursor: pointer; white-space: nowrap; transition: all .15s; }
.btn-copy.done { border-color: var(--green); color: var(--green); }
.btn-claude { background: var(--bg); border: 1.5px solid var(--blue); border-radius: 6px; padding: 4px 10px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--blue); cursor: pointer; white-space: nowrap; transition: all .15s; display: inline-flex; align-items: center; gap: 4px; }
.btn-claude:hover { background: var(--blue); color: #fff; border-color: var(--blue); }
.chevron { color: var(--ink3); font-size: 11px; transition: transform .2s; flex-shrink: 0; }
.card.open .chevron { transform: rotate(180deg); }

/* CARD BODY */
.card-body { display: none; border-top: 1.5px solid var(--border); padding: 14px; background: var(--bg); overflow: hidden; transition: background .2s; }
.card.open .card-body { display: block; }
.md { font-size: 15px; line-height: 1.7; word-break: break-word; overflow-wrap: break-word; font-weight: 400; color: var(--ink); }
@media (max-width: 640px) { .md { font-size: 16px; line-height: 1.7; } }
.md h1,.md h2,.md h3 { font-family: 'Outfit', sans-serif; font-weight: 700; margin: 10px 0 4px; }
.md h1 { font-size: 18px; } .md h2 { font-size: 16px; } .md h3 { font-size: 15px; }
.md p { margin-bottom: 6px; }
.md ul,.md ol { padding-left: 18px; margin-bottom: 6px; }
.md li { margin-bottom: 2px; }
.md strong { font-weight: 700; }
.md code { font-family: 'IBM Plex Mono', monospace; font-size: 13px; background: var(--bg2); border: 1px solid var(--border); border-radius: 4px; padding: 1px 5px; color: var(--red); word-break: break-all; }
.md pre { background: #111; border-radius: 8px; padding: 12px; overflow-x: auto; margin: 10px 0; max-width: 100%; }
.md pre code { background: none; border: none; padding: 0; color: #e8e4dc; word-break: normal; }
.md blockquote { border-left: 3px solid var(--amber); padding: 6px 12px; color: var(--ink2); margin: 8px 0; }
.tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
.tag { font-family: 'IBM Plex Mono', monospace; font-size: 10px; padding: 2px 8px; border-radius: 4px; background: var(--bg2); border: 1px solid var(--border); color: var(--ink2); cursor: pointer; transition: all .12s; }
.tag:hover { border-color: var(--ink); color: var(--ink); }
.tag.active-tag { background: var(--ink); color: var(--bg); border-color: var(--ink); }

/* VARIABLE FORM */
.var-form { background: var(--surface); border: 1.5px solid var(--blue); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
.var-form-title { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--blue); font-weight: 500; margin-bottom: 10px; letter-spacing: 0.05em; }
.var-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
.var-label { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--red); background: var(--bg2); border: 1px solid var(--border); border-radius: 4px; padding: 2px 8px; white-space: nowrap; flex-shrink: 0; }
.var-input { flex: 1; min-width: 140px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 6px; padding: 6px 10px; font-family: 'Noto Sans JP', sans-serif; font-size: 14px; color: var(--ink); outline: none; -webkit-appearance: none; transition: border-color .15s; }
.var-input:focus { border-color: var(--blue); }
.var-preview { background: var(--bg); border: 1.5px solid var(--border); border-radius: 8px; padding: 12px; font-size: 14px; line-height: 1.8; color: var(--ink); white-space: pre-wrap; word-break: break-word; margin-bottom: 10px; max-height: 500px; overflow-y: auto; }
.var-preview mark.unfilled { background: rgba(201,74,42,0.15); border-radius: 3px; color: var(--red); font-style: italic; }
.var-preview mark.filled { background: rgba(42,122,82,0.15); border-radius: 3px; color: var(--green); font-weight: 500; }

mark { background: rgba(212,130,10,0.25); border-radius: 2px; }
.empty { text-align: center; padding: 60px 20px; color: var(--ink3); }
.empty-ico { font-size: 36px; margin-bottom: 10px; }
.empty-txt { font-family: 'Outfit', sans-serif; font-size: 14px; }
.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(60px); background: var(--green); color: #fff; font-family: 'IBM Plex Mono', monospace; font-size: 12px; padding: 9px 20px; border-radius: 20px; z-index: 999; pointer-events: none; transition: transform .3s cubic-bezier(.34,1.56,.64,1); white-space: nowrap; }
.toast.show { transform: translateX(-50%) translateY(0); }
.banner { display: none; background: var(--bg2); border: 1.5px solid var(--red); border-radius: 10px; padding: 14px 16px; margin-bottom: 16px; font-size: 13px; color: var(--red); }
.banner.show { display: block; }
.banner code { font-family: 'IBM Plex Mono', monospace; font-size: 12px; }
.hist-badge { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--ink3); margin-top: 4px; }
</style>
</head>
<body>
<div class="topbar">
  <div class="topbar-inner">
    <div class="logo">PROMPT<em>.</em>LIB</div>
    <div class="search-wrap">
      <span class="search-ico">‚åï</span>
      <input id="search" type="search" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢..." autocomplete="off">
    </div>
    <button class="btn-dark" id="btn-dark" onclick="toggleDark()" title="„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø">üåô</button>
  </div>
</div>
<div class="cat-wrap"><div class="cat-inner" id="cat-list"></div></div>
<div class="main">
  <div class="banner" id="banner"><strong>prompts.json „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ</strong><br>„Çø„Éº„Éü„Éä„É´„Åß <code>python build.py</code> „ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
  <div class="stats" id="stats"></div>
  <div id="list"></div>
</div>
<div class="toast" id="toast"></div>
<script>
let DATA=[], activeCategory='all', query='', activeTag='', cc=0;

// ‚îÄ‚îÄ „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ ‚îÄ‚îÄ
function initDark(){
  const dark = localStorage.getItem('pl_dark')==='1';
  if(dark){ document.body.classList.add('dark'); document.getElementById('btn-dark').textContent='‚òÄÔ∏è'; }
}
function toggleDark(){
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem('pl_dark', isDark?'1':'0');
  document.getElementById('btn-dark').textContent = isDark?'‚òÄÔ∏è':'üåô';
}

// ‚îÄ‚îÄ localStorage ‚îÄ‚îÄ
function getFavs(){ try{ return JSON.parse(localStorage.getItem('pl_favs')||'[]'); }catch(e){ return []; } }
function saveFavs(arr){ localStorage.setItem('pl_favs', JSON.stringify(arr)); }
function getHistory(){ try{ return JSON.parse(localStorage.getItem('pl_history')||'[]'); }catch(e){ return []; } }
function saveHistory(arr){ localStorage.setItem('pl_history', JSON.stringify(arr.slice(0,20))); }

// ‚îÄ‚îÄ „ÅäÊ∞ó„Å´ÂÖ•„Çä ‚îÄ‚îÄ
function isFav(title){ return getFavs().includes(title); }
function toggleFav(title, e){
  e.stopPropagation();
  let favs = getFavs();
  if(favs.includes(title)){ favs = favs.filter(f=>f!==title); toast('„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÇíËß£Èô§„Åó„Åæ„Åó„Åü'); }
  else { favs.push(title); toast('‚ù§Ô∏è „ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü'); }
  saveFavs(favs);
  render();
}

// ‚îÄ‚îÄ Â±•Ê≠¥ ‚îÄ‚îÄ
function addHistory(title){
  let hist = getHistory().filter(h=>h.title!==title);
  hist.unshift({ title, time: Date.now() });
  saveHistory(hist);
}
function timeAgo(ts){
  const d = Date.now() - ts;
  if(d < 60000) return '„Åü„Å£„Åü‰ªä';
  if(d < 3600000) return Math.floor(d/60000)+'ÂàÜÂâç';
  if(d < 86400000) return Math.floor(d/3600000)+'ÊôÇÈñìÂâç';
  return Math.floor(d/86400000)+'Êó•Ââç';
}

const FALLBACK=[{category:"„Çµ„É≥„Éó„É´",icon:"üí°",prompts:[{title:"„Çµ„É≥„Éó„É´",desc:"build.py„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ",tags:[],content:"python build.py „ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",file:""}]}];

async function load(){
  try{ const r=await fetch('./prompts.json'); if(!r.ok) throw 0; DATA=await r.json(); render(); }
  catch(e){ document.getElementById('banner').classList.add('show'); DATA=FALLBACK; render(); }
}

function allPromptsList(){
  return DATA.flatMap(c=>c.prompts.map(p=>({...p,_cat:c.category,_icon:c.icon})));
}

function filtered(){
  let all = allPromptsList();
  if(activeCategory==='‚ù§Ô∏è'){
    const favs=getFavs();
    all=all.filter(p=>favs.includes(p.title));
  } else if(activeCategory==='üïê'){
    const hist=getHistory();
    const histMap=Object.fromEntries(hist.map(h=>[h.title,h.time]));
    all=all.filter(p=>histMap[p.title]);
    all.sort((a,b)=>(histMap[b.title]||0)-(histMap[a.title]||0));
  } else if(activeCategory!=='all'){
    all=all.filter(p=>p._cat===activeCategory);
  }
  if(activeTag){ all=all.filter(p=>(p.tags||[]).includes(activeTag)); }
  if(query){ const q=query.toLowerCase(); all=all.filter(p=>(p.title||'').toLowerCase().includes(q)||(p.desc||'').toLowerCase().includes(q)||(p.content||'').toLowerCase().includes(q)||(p.tags||[]).some(t=>t.toLowerCase().includes(q))); }
  return all;
}

function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function hl(s,q){ if(!q||!s) return esc(s||''); const e=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); return esc(s).replace(new RegExp(`(${e})`,'gi'),'<mark>$1</mark>'); }

function render(){
  cc=0;
  const items=filtered(), total=allPromptsList().length, favCount=getFavs().length, histCount=getHistory().length;

  document.getElementById('stats').innerHTML=
    `<div class="stat"><span class="stat-n">${total}</span><span class="stat-l">„Éó„É≠„É≥„Éó„Éà</span></div>`+
    `<div class="stat"><span class="stat-n">${DATA.length}</span><span class="stat-l">„Ç´„ÉÜ„Ç¥„É™</span></div>`+
    `<div class="stat"><span class="stat-n">${items.length}</span><span class="stat-l">Ë°®Á§∫‰∏≠</span></div>`+
    `<div class="stat"><span class="stat-n">‚ù§Ô∏è${favCount}</span><span class="stat-l">„ÅäÊ∞ó„Å´ÂÖ•„Çä</span></div>`;

  const catEl=document.getElementById('cat-list');
  catEl.innerHTML=
    `<button class="cat-btn${activeCategory==='all'?' active':''}" onclick="setCategory('all')">üóÇ „Åô„Åπ„Å¶</button>`+
    `<button class="cat-btn fav-btn${activeCategory==='‚ù§Ô∏è'?' active':''}" onclick="setCategory('‚ù§Ô∏è')">‚ù§Ô∏è „ÅäÊ∞ó„Å´ÂÖ•„Çä${favCount?` (${favCount})`:''}</button>`+
    `<button class="cat-btn hist-btn${activeCategory==='üïê'?' active':''}" onclick="setCategory('üïê')">üïê Â±•Ê≠¥${histCount?` (${histCount})`:''}</button>`;
  DATA.forEach(c=>{
    catEl.innerHTML+=`<button class="cat-btn${activeCategory===c.category?' active':''}" onclick="setCategory('${c.category.replace(/'/g,"\\'")}')">${c.icon} ${esc(c.category)}</button>`;
  });

  const listEl=document.getElementById('list');
  if(!items.length){ listEl.innerHTML='<div class="empty"><div class="empty-ico">üî≠</div><div class="empty-txt">Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div></div>'; return; }

  // Â±•Ê≠¥„Éª„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅØ„Ç∞„É´„Éº„Éó„Å™„Åó„Åß„Éï„É©„ÉÉ„ÉàË°®Á§∫
  if(activeCategory==='‚ù§Ô∏è'||activeCategory==='üïê'){
    listEl.innerHTML=items.map(p=>cardHtml(p)).join('');
    return;
  }

  const groups={};
  items.forEach(p=>{ if(!groups[p._cat]) groups[p._cat]={icon:p._icon,prompts:[]}; groups[p._cat].prompts.push(p); });
  listEl.innerHTML=Object.entries(groups).map(([cat,g],si)=>
    `<div class="section" id="sec${si}">` +
    `<div class="section-head" onclick="toggleSection('sec${si}')"><span>${g.icon}</span><span class="section-name">${esc(cat)}</span><span class="section-cnt">${g.prompts.length}‰ª∂</span><span class="section-chevron">‚ñæ</span></div>` +
    `<div class="section-body">${g.prompts.map(p=>cardHtml(p)).join('')}</div>` +
    `</div>`
  ).join('');
}

function extractVars(content){
  const matches = content.match(/\{([^}]+)\}/g)||[];
  return [...new Set(matches.map(m=>m.slice(1,-1)))];
}

function buildVarForm(id, content){
  const vars = extractVars(content);
  if(!vars.length) return '';
  const inputs = vars.map(v=>
    `<div class="var-row">` +
    `<span class="var-label">{${esc(v)}}</span>` +
    `<input class="var-input" type="text" placeholder="${esc(v)}„ÇíÂÖ•Âäõ..." oninput="updatePreview('${id}')" data-var="${esc(v)}">` +
    `</div>`
  ).join('');
  return `<div class="var-form">` +
    `<div class="var-form-title">‚úèÔ∏è Â§âÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>` +
    `${inputs}` +
    `<div class="var-preview" id="${id}-preview">${buildPreviewHtml(content, {})}</div>` +
    `</div>`;
}

function buildPreviewHtml(content, vals){
  return esc(content).replace(/\{([^}]+)\}/g, (match, v)=>{
    const val = vals[v]||'';
    if(val) return `<mark class="filled">${esc(val)}</mark>`;
    return `<mark class="unfilled">${match}</mark>`;
  });
}

function getFilledContent(id, content){
  const card = document.getElementById(id);
  if(!card) return content;
  const vals = {};
  card.querySelectorAll('.var-input').forEach(inp=>{ vals[inp.dataset.var]=inp.value; });
  return content.replace(/\{([^}]+)\}/g, (match,v)=> vals[v]||match);
}

function updatePreview(id){
  const card = document.getElementById(id);
  if(!card) return;
  const raw = document.getElementById(id+'-raw').textContent;
  const vals = {};
  card.querySelectorAll('.var-input').forEach(inp=>{ vals[inp.dataset.var]=inp.value; });
  const prev = document.getElementById(id+'-preview');
  if(prev) prev.innerHTML = buildPreviewHtml(raw, vals);
}

function cardHtml(p){
  const id=`c${++cc}`;
  const fav=isFav(p.title);
  const tags=(p.tags||[]).map(t=>`<span class="tag${t===activeTag?' active-tag':''}" onclick="setTag('${esc(t)}',event)">${esc(t)}</span>`).join('');
  const hist=getHistory().find(h=>h.title===p.title);
  const histBadge=hist?`<div class="hist-badge">üïê ${timeAgo(hist.time)}</div>`:'';
  const hasVars = extractVars(p.content||'').length > 0;
  const varForm = hasVars ? buildVarForm(id, p.content||'') : '';
  return `<div class="card${fav?' is-fav':''}" id="${id}">` +
    `<div class="card-top" onclick="toggle('${id}',event)">` +
    `<div class="card-icon">${p._icon||'üìÑ'}</div>` +
    `<div class="card-meta"><div class="card-title">${hl(p.title,query)}</div>${p.desc?`<div class="card-desc">${hl(p.desc,query)}</div>`:''}${histBadge}</div>` +
    `<div class="card-right">` +
    `<button class="btn-fav" onclick="toggleFav('${esc(p.title)}',event)" title="${fav?'„ÅäÊ∞ó„Å´ÂÖ•„ÇäËß£Èô§':'„ÅäÊ∞ó„Å´ÂÖ•„ÇäÁôªÈå≤'}">${fav?'‚ù§Ô∏è':'ü§ç'}</button>`+
    `<button class="btn-copy" onclick="copyPrompt('${id}',event)">COPY</button>` +
    `<button class="btn-claude" onclick="openClaude('${id}',event)">‚ú¶ Claude</button>` +
    `<span class="chevron">‚ñæ</span>` +
    `</div></div>` +
    `<div class="card-body">${varForm}<div class="md">${marked.parse(p.content||'')}</div><div id="${id}-raw" style="display:none">${esc(p.content||'')}</div>${tags?`<div class="tags">${tags}</div>`:''}</div>` +
    `</div>`;
}

function toggle(id,e){ if(e.target.closest('.btn-copy,.btn-fav,.btn-claude,.tag,.var-input')) return; document.getElementById(id).classList.toggle('open'); }
function toggleSection(id){ document.getElementById(id).classList.toggle('collapsed'); }

function copyPrompt(id,e){
  e.stopPropagation();
  const raw = document.getElementById(id+'-raw').textContent;
  const text = getFilledContent(id, raw);
  const card = document.getElementById(id);
  const title = card.querySelector('.card-title')?.textContent||'';
  addHistory(title);
  navigator.clipboard.writeText(text).then(()=>{
    const b=e.target; b.textContent='‚úì OK'; b.classList.add('done');
    setTimeout(()=>{ b.textContent='COPY'; b.classList.remove('done'); },2000);
    toast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
    if(activeCategory==='üïê') render();
  });
}

function openClaude(id,e){
  e.stopPropagation();
  const raw = document.getElementById(id+'-raw').textContent;
  const text = getFilledContent(id, raw);
  const card = document.getElementById(id);
  const title = card.querySelector('.card-title')?.textContent||'';
  addHistory(title);
  navigator.clipboard.writeText(text).then(()=>{
    toast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ Claude„ÇíÈñã„Åç„Åæ„Åô...');
    setTimeout(()=>{ window.open('https://claude.ai','_blank'); },800);
    if(activeCategory==='üïê') render();
  });
}

function setCategory(cat){ activeCategory=cat; activeTag=''; render(); window.scrollTo({top:0,behavior:'smooth'}); }
function setTag(tag,e){ e.stopPropagation(); activeTag=(activeTag===tag?'':tag); activeCategory='all'; render(); }

document.getElementById('search').addEventListener('input',function(){ query=this.value.trim(); activeCategory='all'; render(); });

function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2000); }

initDark();
load();

if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
